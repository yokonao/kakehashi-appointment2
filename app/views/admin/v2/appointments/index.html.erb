<header class="bg-yellow-500 text-white shadow-lg">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">かけはし糖尿病・甲状腺クリニック 管理画面</h1>
    <%= button_to "ログアウト", destroy_administrator_session_path, method: :delete, class: "bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded transition duration-200" %>
  </div>
</header>

<div class="container mx-auto px-4 py-8">
  <% if flash[:notice] %>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert] %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <%= flash[:alert] %>
    </div>
  <% end %>
  <h1 class="text-3xl font-bold mb-6">予約一覧</h1>
  
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-300">
      <thead>
        <tr class="bg-gray-100">
          <th class="px-4 py-2 border-b text-left">患者名</th>
          <th class="px-4 py-2 border-b text-left">生年月日</th>
          <th class="px-4 py-2 border-b text-left">診療歴</th>
          <th class="px-4 py-2 border-b text-left">予約日時</th>
          <th class="px-4 py-2 border-b text-left">診療科</th>
        </tr>
      </thead>
      <tbody>
        <% @appointments.each do |appointment| %>
          <tr class="hover:bg-gray-50 cursor-pointer" onclick="openDrawer('<%= appointment.id %>')" data-appointment-id="<%= appointment.id %>" data-appointment='<%= appointment.to_json(include: :menu) %>'>
            <td class="px-4 py-2 border-b">
              <%= appointment.full_name %>
              <br>
              <span class="text-sm text-gray-600">(<%= appointment.full_kana_name %>)</span>
            </td>
            <td class="px-4 py-2 border-b">
              <%= appointment.birthday.strftime("%Y年%m月%d日") %>
            </td>
            <td class="px-4 py-2 border-b">
              <% if appointment.is_first_visit %>
                <span class="inline-block px-2 py-1 text-xs text-white font-semibold bg-blue-500 rounded">初診</span>
              <% else %>
                <span class="inline-block px-2 py-1 text-xs text-white font-semibold bg-green-500 rounded">再診</span>
                <% if appointment.clinical_number.present? %>
                  <span class="text-sm text-gray-600">（診察券番号: <%= appointment.clinical_number %>）</span>
                <% end %>
              <% end %>
            </td>
            <td class="px-4 py-2 border-b">
              <%= appointment.menu.start_at.strftime("%Y年%m月%d日 %H:%M") %>
            </td>
            <td class="px-4 py-2 border-b">
              <%= appointment.menu.department %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Drawer for appointment details -->
<div id="appointment-drawer" class="fixed right-0 top-0 h-full w-160 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
  <!-- Drawer header -->
  <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-bold">予約詳細</h2>
      <button onclick="closeDrawer()" class="text-gray-500 hover:text-gray-700 cursor-pointer">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- Drawer content -->
  <div id="drawer-content" class="p-6">
    <!-- Content will be dynamically inserted here -->
  </div>
</div>

<!-- Overlay -->
<div id="drawer-overlay" class="fixed inset-0 bg-transparent bg-opacity-50 z-40 hidden" onclick="closeDrawer()"></div>


<script>
  let currentAppointment = null;
  
  function openDrawer(appointmentId) {
    const row = document.querySelector(`[data-appointment-id="${appointmentId}"]`);
    const appointmentData = JSON.parse(row.dataset.appointment);
    currentAppointment = appointmentData;
    
    // Update drawer content
    const drawerContent = document.getElementById('drawer-content');
    drawerContent.innerHTML = `
      <div class="space-y-6">
        <!-- Patient Information -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-700">患者情報</h3>
          <div class="bg-gray-50 rounded-lg p-4 space-y-2">
            <div>
              <span class="text-gray-600">氏名: </span>
              <span class="font-medium">${appointmentData.full_name}</span>
            </div>
            <div>
              <span class="text-gray-600">フリガナ: </span>
              <span class="font-medium">${appointmentData.full_kana_name}</span>
            </div>
            <div>
              <span class="text-gray-600">生年月日: </span>
              <span class="font-medium">${formatDate(appointmentData.birthday)}</span>
            </div>
            <div>
              <span class="text-gray-600">電話番号: </span>
              <span class="font-medium">${appointmentData.phone_number}</span>
            </div>
            <div>
              <span class="text-gray-600">メールアドレス: </span>
              <span class="font-medium">${appointmentData.email}</span>
            </div>
          </div>
        </div>
        
        <!-- Appointment Information -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-700">予約情報</h3>
          <div class="bg-gray-50 rounded-lg p-4 space-y-2">
            <div>
              <span class="text-gray-600">予約日時: </span>
              <span class="font-medium">${formatDateTime(appointmentData.menu.start_at)}</span>
            </div>
            <div>
              <span class="text-gray-600">診療科: </span>
              <span class="font-medium">${appointmentData.menu.department}</span>
            </div>
            <div>
              <span class="text-gray-600">診療歴: </span>
              <span class="font-medium">
                ${appointmentData.is_first_visit ? 
                  '<span class="inline-block px-2 py-1 text-xs text-white bg-blue-500 rounded">初診</span>' : 
                  '<span class="inline-block px-2 py-1 text-xs text-white bg-green-500 rounded">再診</span>'}
              </span>
            </div>
            ${!appointmentData.is_first_visit && appointmentData.clinical_number ? 
              `<div>
                <span class="text-gray-600">診察券番号: </span>
                <span class="font-medium">${appointmentData.clinical_number}</span>
              </div>` : ''}
          </div>
        </div>
        
        <!-- Consultation Details -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-700">相談内容</h3>
          <div class="bg-gray-50 rounded-lg p-4">
            <p class="text-gray-800 whitespace-pre-wrap">${appointmentData.reason || '記載なし'}</p>
          </div>
        </div>
        
        <!-- Free Comment -->
        ${appointmentData.free_comment ? 
          `<div>
            <h3 class="text-lg font-semibold mb-3 text-gray-700">その他コメント</h3>
            <div class="bg-gray-50 rounded-lg p-4">
              <p class="text-gray-800 whitespace-pre-wrap">${appointmentData.free_comment}</p>
            </div>
          </div>` : ''}
        
        <!-- Metadata -->
        <div>
          <h3 class="text-lg font-semibold mb-3 text-gray-700">システム情報</h3>
          <div class="bg-gray-50 rounded-lg p-4 space-y-2">
            <div>
              <span class="text-gray-600">予約ID:</span>
              <span class="font-medium">${appointmentData.id}</span>
            </div>
            <div>
              <span class="text-gray-600">予約作成日時:</span>
              <span class="font-medium">${formatDateTime(appointmentData.created_at)}</span>
            </div>
          </div>
        </div>
        
        <!-- Delete Section -->
        <div class="pt-6 border-t border-gray-200">
          <h3 class="text-lg font-semibold mb-3 text-red-600">予約の削除</h3>
          <form action="/admin/v2/appointments/${appointmentData.id}" method="post" onsubmit="return confirmDelete(event, '${appointmentData.id}')">
            <input type="hidden" name="_method" value="delete">
            <input type="hidden" name="authenticity_token" value="${getAuthenticityToken()}">
            <div class="space-y-3">
              <div>
                <label for="delete-reason-${appointmentData.id}" class="block text-sm font-medium text-gray-700 mb-2">
                  削除理由（5文字以上）<span class="text-red-500">*</span>
                </label>
                <textarea
                  name="reason"
                  id="delete-reason-${appointmentData.id}"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                  placeholder="削除理由を入力してください"
                  oninput="validateDeleteReason('${appointmentData.id}')"
                  required
                ></textarea>
                <div id="delete-reason-error-${appointmentData.id}" class="text-red-500 text-sm mt-1 hidden">
                  削除理由は5文字以上で入力してください
                </div>
              </div>
              <button
                type="submit"
                id="delete-btn-${appointmentData.id}"
                disabled
                class="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded transition duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-red-600"
              >
                予約を削除
              </button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    // Show drawer and overlay
    const drawer = document.getElementById('appointment-drawer');
    const overlay = document.getElementById('drawer-overlay');
    
    overlay.classList.remove('hidden');
    setTimeout(() => {
      drawer.classList.remove('translate-x-full');
    }, 10);
  }
  
  function closeDrawer() {
    const drawer = document.getElementById('appointment-drawer');
    const overlay = document.getElementById('drawer-overlay');
    
    drawer.classList.add('translate-x-full');
    setTimeout(() => {
      overlay.classList.add('hidden');
    }, 300);
  }
  
  function formatDate(dateString) {
    const date = new Date(dateString);
    return `${date.getFullYear()}年${(date.getMonth() + 1).toString().padStart(2, '0')}月${date.getDate().toString().padStart(2, '0')}日`;
  }
  
  function formatDateTime(dateString) {
    const date = new Date(dateString);
    return `${date.getFullYear()}年${(date.getMonth() + 1).toString().padStart(2, '0')}月${date.getDate().toString().padStart(2, '0')}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }
  
  // Get authenticity token for Rails forms
  function getAuthenticityToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
  }
  
  // Close drawer on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeDrawer();
    }
  });
  
  // Delete validation function
  function validateDeleteReason(appointmentId) {
    const reasonInput = document.getElementById(`delete-reason-${appointmentId}`);
    const errorDiv = document.getElementById(`delete-reason-error-${appointmentId}`);
    const deleteBtn = document.getElementById(`delete-btn-${appointmentId}`);
    
    const reason = reasonInput.value.trim();
    
    if (reason.length >= 5) {
      errorDiv.classList.add('hidden');
      deleteBtn.disabled = false;
    } else {
      errorDiv.classList.remove('hidden');
      deleteBtn.disabled = true;
    }
  }
  
  // Confirm before deleting
  function confirmDelete(event, appointmentId) {
    const reasonInput = document.getElementById(`delete-reason-${appointmentId}`);
    const reason = reasonInput.value.trim();
    
    if (reason.length < 5) {
      event.preventDefault();
      alert('削除理由は5文字以上で入力してください');
      return false;
    }
    
    if (!confirm('本当にこの予約を削除しますか？この操作は取り消せません。')) {
      event.preventDefault();
      return false;
    }
    
    return true;
  }
</script>

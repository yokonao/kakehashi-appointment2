<body class="bg-amber-50">
<div class="min-h-screen">
<!-- ヘッダー -->
<header class="bg-white shadow-sm">
<div class="max-w-4xl mx-auto px-4 py-4">
<div class="flex items-center gap-2">
<svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
</svg>
<h1 class="text-xl font-semibold text-gray-800">かけはし糖尿病・甲状腺クリニック</h1>
</div>
</div>
</header>

    <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-amber-700 mb-6 text-center">内科外来予約</h2>
        
        <!-- 週ナビゲーション -->
        <div class="flex justify-between items-center mb-4">
          <% if @week_offset > 0 %>
            <a href="<%= new_appointment_path(week_offset: @week_offset - 1) %>" 
               class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              前の週へ
            </a>
          <% else %>
            <button disabled 
                    class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              前の週へ
            </button>
          <% end %>
          
          <div class="text-center">
            <% start_date = @base_date + 1 %>
            <% end_date = @base_date + 7 %>
            <p class="text-lg font-medium text-gray-700">
              <%= start_date.strftime("%Y年%-m月%-d日") %> 〜 <%= end_date.strftime("%-m月%-d日") %>
            </p>
            <% if @week_offset == 0 %>
              <p class="text-sm text-amber-600">今週</p>
            <% else %>
              <p class="text-sm text-gray-500"><%= @week_offset + 1 %>週目</p>
            <% end %>
          </div>
          
          <% if @week_offset < 3 %>
            <a href="<%= new_appointment_path(week_offset: @week_offset + 1) %>" 
               class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors flex items-center gap-2">
              次の週へ
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          <% else %>
            <button disabled 
                    class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed flex items-center gap-2">
              次の週へ
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          <% end %>
        </div>
        
        <%= form_with url: appointments_path, method: :post, local: true do |f| %>
        <div class="mb-6">
          <div class="mb-4">
            <input type="text" 
                    id="selected_date_display" 
                    placeholder="予約日時"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                    readonly>
            <input type="hidden" name="menu_id" id="menu_id">
            <p class="text-sm text-gray-500 mt-1">下の表から選択してください</p>
          </div>

          <div class="mb-6 overflow-x-auto">
            <table class="w-full min-w-[800px] border-collapse">
              <thead>
                <tr class="bg-gray-50">
                  <th class="border border-gray-300 px-2 py-2 text-sm font-medium"></th>
                  <% 7.times do |i| %>
                    <% date = @base_date + i + 1 %>
                    <th class="border border-gray-300 px-2 py-2 text-sm font-medium" data-date="<%= date %>">
                      <div><%= date.strftime("%-m月%-d日") %></div>
                      <div class="text-xs <%= 'text-red-500' if date.wday == 0 %> <%= 'text-blue-500' if date.wday == 6 %>">
                        <%= %w[日 月 火 水 木 金 土][date.wday] %>
                      </div>
                    </th>
                  <% end %>
                </tr>
              </thead>
              <tbody id="slots_table_body">
                <% time_slots = %w[09:00 09:30 10:00 10:30 11:00 11:30 12:00 14:30 15:00 15:30 16:00 16:30 17:00] %>
                <% time_slots.each do |time| %>
                  <tr>
                    <td class="border border-gray-300 px-2 py-2 text-sm font-medium bg-gray-50"><%= time %></td>
                    <% 7.times do |i| %>
                      <% date = @base_date + i + 1 %>
                      <% menu = @menus_by_date[date]&.find { |m| m.start_at.strftime("%H:%M") == time } %>
                      <% if menu && menu.appointment.blank? %>
                        <td class="border border-gray-300 px-2 py-2 text-center">
                          <button type="button" 
                                  class="slot-button w-full py-1 bg-amber-100 hover:bg-amber-200 rounded text-amber-700 font-medium transition-colors"
                                  data-menu-id="<%= menu.id %>"
                                  data-date="<%= date.strftime('%Y年%m月%d日') %>"
                                  data-time="<%= time %>">
                            ◯
                          </button>
                        </td>
                      <% else %>
                        <td class="border border-gray-300 px-2 py-2 text-center text-gray-400">
                          ✕
                        </td>
                      <% end %>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="space-y-6">
          <div>
            <h3 class="text-lg font-semibold mb-4">2. 氏名</h3>
            <input type="text" id="full_name" name="full_name" placeholder="架橋　花子" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <p class="text-sm text-gray-500 mt-1">氏名</p>

            <input type="text" id="full_kana_name" name="full_kana_name" placeholder="カケハシ ハナコ" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <p class="text-sm text-gray-500 mt-1">カナ</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-4">3. 生年月日・電話番号・メールアドレス</h3>
            <input type="number" id="birthday" name="birthday" placeholder="19930101" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <p class="text-sm text-gray-500 mb-4">1993年1月1日生 → 19930101</p>

            <input type="tel" id="phone_number" name="phone_number" placeholder="0524833377" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 mb-1">
            <p class="text-sm text-gray-500 mb-4">電話番号（ハイフン無し）</p>

            <input type="email" id="email" name="email" placeholder="test@example.com" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 mb-1">
            <p class="text-sm text-gray-500">メールアドレス</p>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-4">4. 当院を初めてご利用になりますか？</h3>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="is_first_visit" value="true" required class="mr-2" id="first_visit_yes">
                <span>はい</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="is_first_visit" value="false" required class="mr-2" id="first_visit_no">
                <span>いいえ</span>
              </label>
              <div id="clinical_number_field" class="mt-4" style="display: none;">
                <input type="text" id="clinical_number" name="clinical_number" placeholder="00028" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p class="text-sm text-gray-500 mt-1">再診の方は診察券番号を入力してください</p>
              </div>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-4">5. 受診理由（複数選択可）</h3>
            <div class="space-y-2">
              <% %w[糖尿病 甲状腺 その他].each do |reason| %>
                <label class="flex items-center">
                  <input type="checkbox" name="consultation_reason[]" value="<%= reason %>" class="mr-2">
                  <span><%= reason %></span>
                </label>
              <% end %>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-4">6. その他（任意）</h3>
            <textarea id="free_comment" name="free_comment" rows="5" placeholder="診察前に伝えておきたいことをご自由にお書きください"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"></textarea>
            <p class="text-sm text-gray-500 mt-1">自由記入欄</p>
          </div>

          <div class="flex justify-center gap-4">
            <a href="<%= new_appointment_path %>" 
                class="px-8 py-3 bg-gray-400 text-white font-medium rounded-lg hover:bg-gray-500 transition-colors">
              戻る
            </a>
            <button type="submit" 
                    class="px-8 py-3 bg-amber-600 text-white font-medium rounded-lg hover:bg-amber-700 transition-colors">
              予約を確定する
            </button>
          </div>
        </div>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // スロット選択機能
      const slotButtons = document.querySelectorAll('.slot-button');
      const selectedDateDisplay = document.getElementById('selected_date_display');
      const menuIdInput = document.getElementById('menu_id');
      
      slotButtons.forEach(button => {
        button.addEventListener('click', function() {
          // 既存の選択を解除
          document.querySelectorAll('.slot-button').forEach(b => {
            b.classList.remove('bg-amber-500', 'text-white');
            b.classList.add('bg-amber-100', 'text-amber-700');
          });
          
          // 新しい選択を適用
          this.classList.remove('bg-amber-100', 'text-amber-700');
          this.classList.add('bg-amber-500', 'text-white');
          
          // フォームの値を更新
          const menuId = this.dataset.menuId;
          const date = this.dataset.date;
          const time = this.dataset.time;
          
          selectedDateDisplay.value = `${date} ${time}`;
          menuIdInput.value = menuId;
        });
      });

      // 初診・再診の切り替えによる診察券番号フィールドの表示制御
      const firstVisitYes = document.getElementById('first_visit_yes');
      const firstVisitNo = document.getElementById('first_visit_no');
      const patientIdField = document.getElementById('clinical_number_field');
      const patientIdInput = document.getElementById('clinical_number');
      
      firstVisitYes.addEventListener('change', function() {
        if (this.checked) {
          patientIdField.style.display = 'none';
          patientIdInput.value = '';
          patientIdInput.removeAttribute('required');
        }
      });
      
      firstVisitNo.addEventListener('change', function() {
        if (this.checked) {
          patientIdField.style.display = 'block';
          patientIdInput.setAttribute('required', 'required');
        }
      });
    });
  </script>
</body>
</html>
